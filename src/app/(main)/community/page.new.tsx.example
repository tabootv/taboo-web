/**
 * Example: Migrated Community Page using new API structure
 * 
 * This demonstrates how to migrate from old API to new TanStack Query hooks
 * with optimistic updates for mutations
 */

'use client';

import Link from 'next/link';
import { Rss, Star, MessageCircle } from 'lucide-react';
import { CreatePostCard, FeedPost, PostSkeleton } from '@/components/community';
import { useAuthStore } from '@/lib/stores';
import { usePostsList, useCreatePost, useDeletePost } from '@/api/queries';
import { useMemo } from 'react';

export default function CommunityPage() {
  const { user } = useAuthStore();

  // New: Use TanStack Query hook
  const {
    data,
    isLoading,
    isFetchingNextPage,
    hasNextPage,
    fetchNextPage,
  } = usePostsList();

  const createPost = useCreatePost();
  const deletePost = useDeletePost();

  // Flatten pages into single array
  const postsList = useMemo(() => {
    return data?.pages.flatMap((page) => page.data) || [];
  }, [data]);

  const handlePostCreated = async (caption: string, image?: File) => {
    await createPost.mutateAsync({ caption, image });
  };

  const handleDeletePost = async (id: number) => {
    await deletePost.mutateAsync(id);
  };

  return (
    <div className="series-page-atmosphere min-h-screen">
      <div className="series-atmosphere-bg" />

      <div className="relative z-10">
        <div className="max-w-[1280px] mx-auto px-4 md:px-6 lg:px-8 pt-4 pb-3">
          <div className="relative flex items-center min-h-[44px]">
            <h1 className="text-2xl md:text-3xl font-bold text-white absolute left-0">
              Community Posts
            </h1>
            <div className="w-full flex justify-center">
              <div className="flex gap-2">
                <Link
                  href="/community"
                  className="inline-flex items-center gap-2 px-5 py-2.5 rounded-full bg-red-primary/10 text-red-primary border border-red-primary/30 font-medium text-sm transition-all hover:bg-red-primary/20"
                >
                  <Rss className="w-4 h-4" />
                  Posts
                </Link>
                <Link
                  href="/creator"
                  className="inline-flex items-center gap-2 px-5 py-2.5 rounded-full bg-white/5 text-text-secondary border border-white/10 font-medium text-sm transition-all hover:bg-white/10 hover:text-white"
                >
                  <Star className="w-4 h-4" />
                  Creators
                </Link>
              </div>
            </div>
          </div>
        </div>

        <div className="max-w-[820px] mx-auto px-4 md:px-6 lg:px-8 space-y-4 pb-12 mt-4">
          {user?.channel && (
            <CreatePostCard user={user} onPostCreated={handlePostCreated} />
          )}

          <div className="space-y-4">
            {isLoading ? (
              Array.from({ length: 3 }).map((_, i) => <PostSkeleton key={i} />)
            ) : postsList.length > 0 ? (
              <>
                {postsList.map((post) => (
                  <FeedPost
                    key={post.id}
                    post={post}
                    currentUserId={user?.id}
                    onDelete={handleDeletePost}
                  />
                ))}

                {hasNextPage && (
                  <div className="flex justify-center py-8">
                    <button
                      onClick={() => fetchNextPage()}
                      disabled={isFetchingNextPage}
                      className="px-6 py-2 bg-surface hover:bg-surface/80 text-white rounded-lg transition-colors disabled:opacity-50"
                    >
                      {isFetchingNextPage ? 'Loading...' : 'Load More'}
                    </button>
                  </div>
                )}

                {!hasNextPage && postsList.length > 0 && (
                  <p className="text-text-secondary text-sm text-center py-8">
                    You've reached the end of the feed
                  </p>
                )}
              </>
            ) : (
              <div className="flex flex-col items-center justify-center py-16 text-center">
                <div className="w-20 h-20 rounded-full bg-[#131315] flex items-center justify-center mb-6">
                  <MessageCircle className="w-8 h-8 text-red-primary" />
                </div>
                <h3 className="text-xl font-semibold text-white mb-2">No posts yet</h3>
                <p className="text-text-secondary max-w-sm">
                  Be the first to share something with the community!
                </p>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

